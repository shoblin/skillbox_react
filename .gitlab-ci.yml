image: node:lts-stretch-slim
stages:
    - Build
    - Test
    - Deploy
    - Revert

variables: 
    new_deploy_dir: 'www/test-app/$CI_COMMIT_SHORT_SHA'
    docker_html_path: '/www/html'


install_dependencies:
    stage: Build
    tags:
        - test-react
    script:
        - yarn install
        - yarn build
    artifacts: 
        paths:
            - node_modules
            - build
    cache:
        key:
            files:
                - .yarn.lock
        paths: 
            - node_modules

linter:
    stage: Test
    tags: 
        - test-react
    script: 
        - yarn linter

unit_test:
    stage: Test
    tags:
        - test-react
    script: 
        - CI=True yarn test

test_delpoy:
    stage: Deploy
    tags: 
        - deploy-node-js
    script:   
        - mkdir -p $DIR
        - cp -r build/. /$new_deploy_dir
        - cp -Pv $docker_html_path /$new_deploy_dir/prev-version
        - ln -fsnv /var/$new_deploy_dir/ $docker_html_path


revert_prev_version:
    stage: Revert
    tags: 
        - deploy-node-js
    when: manual
    script:  
        - cp -Pv --remove-destination /$new_deploy_dir/prev-version $docker_html_path
           
